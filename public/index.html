<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Home Page</title>
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <link href="https://fonts.googleapis.com/css?family=Bebas+Neue|Oswald:300,400&display=swap" rel="stylesheet">
    <!--<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>-->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
      integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
      crossorigin=""
    ></script>
  </head>
  <body>
    <div class = "wrapper">

        <!-- TOP-LEVEL HTML ELEMENTS -->
        <div class = "top-level">
            <nav>
              <h1 class = "logo">FarmFind</h1>
              <div class = "pages">
              <a href="index.html">HOME</a>
              <a href="about.html">ABOUT US</a>
              <a href="documentation.html">DOCUMENTATION</a>
              </div>
            </nav>
        </div>
        <h1 class = "main-heading"> HOME </h1>

        <!-- MAIN CONTENT HTML ELEMENTS -->
        <div class = "main-content">
          <div class = "top-content">
            <div class = "find">
                <h2>Find a Market</h2>
                <div class = "find-box">
                    <div class = "filter">
                      <form id = "form">
                        <p>Days:</p>
                        <input type = "checkbox" id = "sunday" name = "sunday" value = "No" disabled>
                        <label for = "sunday">Su</label>
                        <input type = "checkbox" id = "monday" name = "monday" value = "No" disabled>
                        <label for = "monday">M</label>
                        <input type = "checkbox" id = "tuesday" name = "tuesday" value = "No" disabled>
                        <label for = "tuesday">T</label>
                        <input type = "checkbox" id = "wednesday" name = "wednesday" value = "No" disabled>
                        <label for = "wednesday">W</label>
                        <input type = "checkbox" id = "thursday" name = "thursday" value = "No" disabled>
                        <label for = "thursday">Th</label>
                        <input type = "checkbox" id = "friday" name = "friday" value = "No" disabled>
                        <label for = "friday">F</label>
                        <input type = "checkbox" id = "saturday" name = "saturday" value = "No" disabled>
                        <label for = "saturday">Sa</label>

                        <p>Hours of Operation:</p>
                        <input type="time" id = "time_lower" min="00:00:00" max="24:00:00" disabled>
                        <input type="time" id = "time_upper" min="00:00:00" max="24:00:00" disabled>
                        <label for = "time"></label>

                        <p>Payment Options:</p>
                        <input type = "checkbox" id = "credit" name = "credit" value = "No">
                        <label for = "credit", title = "Accepts payment through credit card">Credit</label>
                        <input type = "checkbox" id = "wic" name = "wic" value = "No">
                        <label for = "wic", title = "Accepts checks for fruits and vegetables through the Special Supplemental Nutrition Program for Women, Infants, and Children (WIC)">WIC</label>
                        <input type = "checkbox" id = "wiccash" name = "wiccash" value = "No">
                        <label for = "wiccash", title = "Accepts cash-value vouchers (CVV) for fruits and vegetables through the Special Supplemental Nutrition Program for Women, Infants, and Children (WIC)">WIC Cash</label>
                        <input type = "checkbox" id = "sfmnp" name = "sfmnp" value = "No">
                        <label for = "sfmnp", title = "Accepts coupons through the Senior Farmers' Market Nutrition Program (SFMNP)">SFMNP</label>
                        <input type = "checkbox" id = "snap" name = "snap" value = "No">
                        <label for = "sfmnp", title = "Allows customers to use benefits through the Supplemental Nutrition Assistance Program (SNAP)">SNAP</label>

                        <p>Goods Offered:</p>
                        <input type = "checkbox" id = "bakedgoods" name = "bakedgoods" value = "No">
                        <label for = "baked goods">Baked Goods</label>
                        <input type = "checkbox" id = "cheese" name = "cheese" value = "No">
                        <label for = "cheese">Cheese</label>
                        <input type = "checkbox" id = "crafts" name = "crafts" value = "No">
                        <label for = "crafts">Crafts</label>
                        <br>
                        <input type = "checkbox" id = "eggs" name = "eggs" value = "No">
                        <label for = "eggs">Eggs</label>
                        <input type = "checkbox" id = "flowers" name = "flowers" value = "No">
                        <label for = "flowers">Flowers</label>
                        <input type = "checkbox" id = "seafood" name = "seafood" value = "No">
                        <label for = "seafood">Seafood</label>
                        <input type = "checkbox" id = "herbs" name = "herbs" value = "No">
                        <label for = "herbs">Herbs</label><br>
                        <input type = "checkbox" id = "honey" name = "honey" value = "No">
                        <label for = "honey">Honey</label>
                        <input type = "checkbox" id = "jams" name = "jams" value = "No">
                        <label for = "jams">Jams</label>
                        <input type = "checkbox" id = "maple" name = "maple" value = "No">
                        <label for = "maple">Maple</label>
                        <input type = "checkbox" id = "meat" name = "meat" value = "No">
                        <label for = "meat">Meat</label>
                        <input type = "checkbox" id = "nursery" name = "nursery" value = "No">
                        <label for = "nursery">Nursery</label>
                        <input type = "checkbox" id = "nuts" name = "nuts" value = "No">
                        <label for = "nuts">Nuts</label>
                        <input type = "checkbox" id = "plants" name = "plants" value = "No">
                        <label for = "plants">Plants</label><br>
                        <input type = "checkbox" id = "poultry" name = "poultry" value = "No">
                        <label for = "poultry">Poultry</label>
                        <input type = "checkbox" id = "prepared" name = "prepared" value = "No">
                        <label for = "prepared">Prepared</label>
                        <input type = "checkbox" id = "soap" name = "soap" value = "No">
                        <label for = "soap">Soap</label>
                        <input type = "checkbox" id = "trees" name = "trees" value = "No">
                        <label for = "trees">Trees</label>
                        <input type = "checkbox" id = "vegetables" name = "vegetables" value = "No">
                        <label for = "vegetables">Vegetables</label>
                        <input type = "checkbox" id = "wine" name = "wine" value = "No">
                        <label for = "wine">Wine</label>
                        <br>
                        <br>
                        <button type="submit">Filter Results</button>
                      </form>

                    </div>

                </div>
                </div>
              
            <div class = "map">
                <h2>Map</h2>
                <div class = "map-box" id = "map-box"></div>
            </div>
          </div>
        
          <div class = "bottom-content" id = "results-container">
          

        </div>
        </div>
      </div>

        

    <script type="module">

        /*********************/
        /* JS for Market Map */
        /*********************/

       
          // Initializing the map and setting its view to our 
          // chosen geographical coordinates and a zoom level:
          const mymap = L.map('map-box').setView([38.9881, -76.9416], 13);

          // Adding a tile layer to the map:
          const tileLayer = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
          attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
          maxZoom: 18,
          id: 'mapbox/streets-v11',
          tileSize: 512,
          zoomOffset: -1,
          accessToken: 'pk.eyJ1IjoibmljaG9sYXNkc3Rld2FydCIsImEiOiJjazhqaHF1d2owMmM1M2ZxNmE5ZjF0dHpuIn0.2OzyXmdy62C4ZZLJtCTI_w'
          }).addTo(mymap);

          // Creating a marker and pop up:
          // Code Referenced: https://joshuafrazier.info/leaflet-basics/ */

          const customOptions = {
          'maxWidth': '500',
          'className' : 'custom'
          }
       

        /**********************/
        /* PROCESS USER INPUT */
        /**********************/

        function getUserData(event) {

          /*
            fetch("/api", {
            method: "GET",
          })
          .then((data) => console.log(data.text()));
          */

          // Remove previously created results table
          let removeTable = document.querySelector('#results-container');
          removeTable.innerHTML = "";
          //if ($('div#results-container').has(removeTable).length) {
              //let parentEl = removeTable.parentElement;
          //}
          //parentEl.removeChild(removeTable);

          // clear all markers (possibly from last search)
          mymap.eachLayer((layer) => { 
            if (layer != tileLayer) { // check to see if the layer is the tile layer
              mymap.removeLayer(layer);
            }
          });
          
          event.preventDefault(); // prevents the page from reloading on button click
          console.log('Data submitted')


          const checkbox_list = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "credit", "wic",
                          "wiccash", "sfmnp", "snap", "bakedgoods", "cheese", "crafts", "eggs", "flowers", "herbs", "honey", "jams", "maple",
                          "meat", "nursery", "nuts", "plants", "poultry", "prepared", "soap", "trees", "vegetables", "wine", "seafood"];

          // If a checkbox is checked, that checkbox's element value becomes "1"
          checkbox_list.forEach((item) => {
            let box_item = document.getElementById(item);
            if (box_item.checked) {
              box_item.value = "Yes";
            }
            else {box_item.value = "No"};
          }) 

          // Creating an object with form data:
          const formToSend = new FormData(form);
          console.log("Form data object created");

          // Using fetch to send the form data to the back-end:
          fetch("/api", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(Object.fromEntries(formToSend)),
          })
          .then((data) => data.json())
          .then((json_response) => {

            console.log(json_response)

            // Update results box
            // create h2 and append to results-container
            let table_header = document.createElement('h2');
            table_header.innerHTML = "Filter Results";
            document.getElementById('results-container').appendChild(table_header);
            let table = document.createElement('table'), tr, td_name, td_site;
            table.setAttribute("id", "results-table");
            //let th = document.createElement('th');
            //th.innerHTML = "Results";
            //table.appendChild(th);
            json_response.forEach((item) => {
                tr = document.createElement('tr');
                td_name = document.createElement('td');
                td_site = document.createElement('td');
                tr.appendChild(td_name);
                tr.appendChild(td_site)
                td_name.innerHTML = item["market_name"];
                if (!('website' in item)){
                  td_site.innerHTML = "N/A";
                }
                else {
                  let a = document.createElement('a');
                  /*td_site.innerHTML = item["website"]*/
                  let link = document.createTextNode(item["website"])
                  a.appendChild(link); 
                  /*a.title = item["website"];*/
                  a.href = item["website"]; 
                  td_site.appendChild(a); 
                }
                table.appendChild(tr);
                }
            )
            document.getElementById('results-container').appendChild(table);
            let br1 = document.createElement('br');
            document.getElementById('results-container').appendChild(br1);


            Object.entries(json_response).map((item) => {
                //console.log(item[1]["location"]['latitude']);
                /* ADD MARKERS AND POP UPS HERE */

                //L.marker([item[1]["location"]["latitude"], item[1]["location"]["longitude"]]).bindPopup(item[1]["market_name"], customOptions).addTo(mymap).openPopup();
                mymap.addLayer(L.marker([item[1]["location"]["latitude"], item[1]["location"]["longitude"]]).bindPopup(item[1]["market_name"], customOptions));
          })
        });

        /*
        fetch("/api", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(Object.fromEntries(formToSend)),
          })
          .then((data) => data.json())
          .then((json_response) => {
            console.log(json_response);
          });
        */

            // Resetting the values of the form (just in case):
            document.getElementById("form").reset();

            // Checkbox element values are reset to "0"
            checkbox_list.forEach((item) => {
              let box_item = document.getElementById(item);
              box_item.value = "No";
            })
        } // end of getUserData function
        
        const form = document.getElementById('form');
        form.addEventListener("submit", getUserData);

        
        
      
        
        
        

    </script>

  </body>
</html>